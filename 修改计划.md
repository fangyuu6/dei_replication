# DEI 论文修改计划：回应五项批评 + 精致化成本曲线新概念

> 日期：2026-02-25
> 数据集：334道菜 / 29菜系 (combined_dish_DEI.csv)
> 目标：Nature级别发表

---

## 一、问题诊断

### 批评1：H分数压缩 (0.04分差异不合理)

**现状**：BERT微调后H range = [6.05, 7.57]，CV仅3.9%。论文声称"排名最高和最低的菜味道只差0.04分"缺乏可信度。

**原因分析**：
- BERT情感模型的天花板效应：将本应存在的真实差异"压平"
- Yelp评论正向偏差：人们倾向评价自己喜欢的食物，负面评价稀少
- 均值聚合进一步压缩了个体差异

**与Food-Pics实验数据相关性仅r=0.175**，说明NLP代理测量与真实味觉体验关联很弱。

### 批评2：Yelp代理偏差

**现状**：
- 餐厅层面ICC = 8.3%，菜品层面ICC = 2.4%
- 68.2%的菜品H方差由混杂因素（主要是餐厅平均评分）解释
- 评论中的享乐表达受餐厅整体体验影响

### 批评3：缺少营养维度

**现状**：DEI = H/E 只考虑"好吃"和"环保"两个维度，完全忽略营养贡献。

**问题**：
- Top菜品（kimchi, papaya_salad, coleslaw）全是配菜/小食，蛋白质/热量极低
- Bottom菜品（brisket, steak）提供高质量蛋白、铁、锌、B12
- 把15kcal的泡菜和500kcal的牛腩放在同一排名比"效率"，功能上不对等

### 批评4：菜品功能不对等

**现状**：跨类别比较（沙拉 vs 主菜）夸大了替代可行性。brisket→ceviche的替代建议忽略了热量和蛋白质需求。

### 新概念C5：精致化成本曲线

**灵感**：服务员为了让打包好看多用一个碗→增加一道洗碗工序。类推到食物：从基础版到精致版，每一步升级增加了多少环境成本？味觉回报是否成比例？

**核心洞见**：同一道菜的不同呈现方式的比较，比比较完全不同的菜更有实际操作指导意义。

---

## 二、修改方案

### 脚本11a：H分数压缩分析 (`code/11a_h_decompression.py`)

**目的**：量化压缩程度，展示DEI排名对H展宽的稳健性

**四项分析**：

#### 分析1：压缩量化
```
compression_factor = CV_expected / CV_observed
```
- 对比Yelp星级dish-level CV（预期~15-20%）vs BERT H的CV（3.9%）
- 对比Food-Pics实验数据的CV作为基准

#### 分析2：Beta分布反压缩
```python
# 将H归一化到[0,1]，拟合beta分布，用分位数函数展开
H_norm = (H - H_min) / (H_max - H_min)
H_rescaled = beta.ppf(rank / (N+1), a, b) * (9 - 3) + 3  # 目标范围[3,9]
```
保序变换，扩展差异但不改变排名。

#### 分析3：敏感性分析（核心图）
```
模拟H分布在CV = 5%, 10%, 15%, 20%时：
  → 重新计算Var(log H) / Var(log DEI)
  → 找到"交叉点"：H贡献 ≥ 10% of Var(log DEI)需要多大CV？
```
**预期结果**：需要CV > 20%（约当前5倍）才能使H贡献10%+。这说明即使真实H差异比观测大5倍，E仍主导DEI。

#### 分析4：排名稳定性
- 各反压缩场景下DEI排名的Spearman ρ（预期 > 0.95）
- 有多少菜品跨越tier（quintile变化）

**输出**：
| 文件 | 内容 |
|------|------|
| `results/tables/h_compression_analysis.csv` | 压缩因子、分布参数 |
| `results/tables/h_decompression_sensitivity.csv` | 各CV场景下H贡献%和排名相关 |
| `results/figures/h_decompression_sensitivity.png` | **关键图**：CV vs H贡献% |
| `results/figures/h_rescaled_distribution.png` | 原始 vs 反压缩 H分布对比 |

---

### 脚本11b：Yelp代理偏差控制 (`code/11b_yelp_proxy_controls.py`)

**目的**：剥离餐厅层面混杂因素，获得"纯菜品"H分数

**方法**：两阶段残差化（参考07d_h_validity.py已有模板）

#### 阶段1：Review级回归
```
H_ij = α + β₁·biz_stars_j + β₂·price_range_j + β₃·log(biz_review_count_j) + β₄·text_len_ij + ε_ij
```

#### 阶段2：提取控制后H
```
H_controlled_ij = H_ij - (β₁·biz_stars + β₂·price + β₃·log(count))
# 仅去除餐厅级混杂，保留评论级变异
```

#### 阶段3：重新聚合到dish级
```
H_controlled_dish_k = mean(H_controlled_ij) for dish k
log_DEI_controlled = log(H_controlled) - log(E)
```

#### 阶段4：影响评估
- Spearman ρ(DEI_original, DEI_controlled)
- tier变化矩阵
- 最大受影响菜品（rank shift > 20位）
- 重新计算方差分解和Pareto前沿

**数据源**：
- `data/dish_mentions_scored.parquet`（76,927条，原始158道菜）
- `data/expanded_dish_mentions.parquet`（扩展176道菜）
- `data/restaurants.parquet`（餐厅星级、价格、评论数）

**输出**：
| 文件 | 内容 |
|------|------|
| `results/tables/controlled_dei_rankings.csv` | 334道菜原始 vs 控制后H和DEI |
| `results/tables/proxy_bias_summary.csv` | 方差分解对比 |
| `results/figures/controlled_vs_original_dei.png` | 散点+排名对比图 |

---

### 脚本11c：营养维度 (`code/11c_nutritional_dimension.py`)

**目的**：加入营养密度作为第三维度，构建DEI-N

#### 步骤1：营养数据库构建

为101种食材硬编码USDA FoodData Central数据（每kg）：

```python
NUTRIENT_DATA = {
    "beef": {"protein_g": 260, "fat_g": 150, "carb_g": 0, "fiber_g": 0,
             "iron_mg": 26, "zinc_mg": 45, "b12_ug": 25, "calcium_mg": 180,
             "vitamin_c_mg": 0, "calorie_kcal": 2500},  # USDA FDC #174032
    "chicken": {"protein_g": 209, "fat_g": 90, ...},
    "tofu": {"protein_g": 80, "fat_g": 48, ...},
    # ... 101种食材
}
```

工作量：101 × 10 = 1,010个数据点。USDA数据明确无歧义。

#### 步骤2：菜品营养谱计算

```python
for dish, recipe in ALL_RECIPES.items():
    for ingredient, grams in recipe.items():
        kg = grams / 1000
        dish_protein += kg * NUTRIENT_DATA[ingredient]["protein_g"]
        # ... 所有营养素
```

#### 步骤3：NDI (Nutrient Density Index)

采用Drewnowski (2009) NRF框架：
```
NDI = (1/7) * Σ [(nutrient_k / DRV_k) × 100]    per 100 kcal
```
7项鼓励营养素：蛋白质、纤维、铁、锌、B12、钙、维生素C

#### 步骤4：DEI-N公式

```
log(DEI_N) = log(H) + α·log(NDI) - log(E)
```
- α = 0.5（默认），敏感性分析 α ∈ [0, 1]，步长0.1
- α=0 时退化为原始DEI
- α=1 时营养与味道等权

#### 步骤5：3D Pareto分析

在(H, 1/E, NDI)三维空间找Pareto前沿。一道菜Pareto最优 ⟺ 没有其他菜同时更好吃、更环保、更有营养。

**预期**：原来的7道Pareto最优菜（多为配菜）中部分会被更有营养的菜品取代。

#### 步骤6：餐点角色分类

```python
MEAL_ROLE = {
    "Side/Snack":  cal < 200,   # kimchi, edamame, guacamole
    "Light Main":  200 ≤ cal < 400,  # salads, soups
    "Full Main":   400 ≤ cal < 700,  # pasta, curry, stir-fry
    "Heavy Main":  cal ≥ 700    # brisket, lasagna, biryani
}
```

**输出**：
| 文件 | 内容 |
|------|------|
| `data/ingredient_nutrients.csv` | 101食材 × 10营养素 |
| `data/dish_nutritional_profiles.csv` | 334菜品 × 营养谱 + NDI + 餐点角色 |
| `results/tables/dei_n_rankings.csv` | DEI-N排名（多个α值） |
| `results/figures/3d_pareto_hne.png` | 三维Pareto前沿 |
| `results/figures/dei_vs_dein_comparison.png` | DEI vs DEI-N排名迁移 |

---

### 脚本11d：类内分析 (`code/11d_within_category_analysis.py`)

**依赖**：11c的`dish_nutritional_profiles.csv`

**目的**：在功能等价的类别内部做DEI比较，展示营养约束下的替代方案

#### 步骤1：基于食谱的功能分类

```python
# 按主要蛋白来源 + 热量角色分类（而非关键词匹配）
def classify_dish(recipe, nutrients):
    beef_g = sum(recipe[i] for i in ["beef", "ground_beef", "veal", "lamb"])
    poultry_g = sum(recipe[i] for i in ["chicken", "duck", "turkey"])
    seafood_g = sum(recipe[i] for i in ["shrimp", "fish", "salmon", ...])

    if beef_g > 100: return "Red Meat Main"
    if poultry_g > 100: return "Poultry Main"
    if seafood_g > 80: return "Seafood Main"
    if legume_g > 80: return "Plant Protein"
    if cal < 200: return "Side/Snack"
    # ...
```

目标：<5%落入"Other"（当前关键词方法有208/334落入Other）

#### 步骤2：类内DEI排名和Pareto前沿

每个类别内部：
- DEI排名和方差分解
- **关键假设检验**：类内H的CV是否高于全局？
  - 预期：**是**。因为类内菜品更可比，H差异信号更清晰
  - 这证明H在同类比较中更有区分力

#### 步骤3：营养约束替代矩阵

```python
for dish_from in high_E_dishes:
    for dish_to in same_category_dishes:
        if (E_to < E_from * 0.7 and           # E减少≥30%
            protein_to >= protein_from * 0.5 and  # 蛋白质≥50%
            abs(cal_to - cal_from) / cal_from < 0.5 and  # 热量±50%
            H_from - H_to < 1.0):              # H损失<1分
            → 记录为可行替代
```

**输出**：
| 文件 | 内容 |
|------|------|
| `results/tables/comprehensive_category_assignment.csv` | 334菜品的食谱级分类 |
| `results/tables/within_category_dei_rankings.csv` | 类内排名 |
| `results/tables/within_category_variance.csv` | 类内H贡献%（预期>全局0.8%） |
| `results/tables/nutrition_constrained_substitutions_full.csv` | 营养约束替代方案 |
| `results/figures/within_category_dei_panels.png` | 多面板类内Pareto图 |

---

### 脚本11e：精致化成本曲线 (`code/11e_refinement_curve.py`)

**目的**：提出并验证新概念——"精致化的边际环境代价远超边际味觉回报"

#### 步骤1：定义菜品家族

从334道菜中识别17个自然家族：

| 家族 | 菜品数 | 代表性变体（基础→精致） |
|------|--------|----------------------|
| Curry | 10 | dal → chana_masala → green_curry → butter_chicken → massaman |
| Noodle | 11 | wonton_noodles → lo_mein → pad_thai → ramen → lasagna |
| Rice | 9 | fried_rice → bibimbap → biryani → paella → risotto |
| Chicken | 9 | chicken_sandwich → tandoori → kung_pao → fried_chicken → coq_au_vin |
| Beef | 10 | hamburger → bulgogi → steak → beef_bourguignon → brisket |
| Salad | 8 | coleslaw → caesar → caprese → nicoise → cobb |
| Dessert | 7 | gelato → panna_cotta → tiramisu → creme_brulee → cheesecake |
| Seafood | 8 | ceviche → sushi → fish_tacos → bouillabaisse → fish_and_chips |
| Vegetable | 7 | guacamole → hummus → dal → falafel → chana_masala |
| Kimchi | 3 | kimchi → kimchi_jjigae → bossam |
| Soup | 7 | miso → tom_yum → borscht → clam_chowder → french_onion |
| Bread | 6 | pita → naan → focaccia → croissant → bruschetta |
| Pork | 7 | samgyeopsal → adobo → carnitas → pork_katsu → ribs |
| Wrapped | 7 | spring_roll_fresh → dumpling → gyoza → samosa → empanada |
| Kebab | 6 | satay → kebab → souvlaki → doner → iskender |
| Egg | 6 | tamagoyaki → shakshuka → eggs_benedict → okonomiyaki |
| Flatbread | 6 | pizza_margherita → lahmacun → pide → pizza |

#### 步骤2：精致度评分

```python
refinement_score = (
    0.30 * log(n_ingredients / n_ingredients_min_in_family) +
    0.20 * log(total_grams / total_grams_min) +
    0.20 * animal_protein_fraction +
    0.15 * (cooking_energy / max_cooking_energy) +
    0.15 * high_impact_ingredient_share
)
```

#### 步骤3：核心数学模型

**家族级模型**：
```
H_fi = H_base_f + α_f · log(E_fi / E_base_f) + ε_fi
```

- `H_base_f` = 家族中最简单菜品的H
- `E_base_f` = 家族中最简单菜品的E
- `α_f` = **环境弹性系数**：E每翻一倍，H增加α_f分

**解读**：
- α_f = 0.5 → E翻倍仅获0.5分味觉提升（10分制）
- α_f = 1.0 → E翻倍获1分味觉提升
- 预期范围：0.5-1.5

**全局混合效应模型**：
```
(H - H_base) = α_global · log(E / E_base) + u_family + ε
```
u_family ~ N(0, σ²_family) 为家族随机效应

#### 步骤4：缺失基础版本的模拟

对缺少"基础版"的家族，用食谱操作生成：
```python
def create_base_variant(refined_recipe):
    """去除精致化成分，降级烹饪方式"""
    base = {}
    for ingredient, grams in refined_recipe.items():
        # 替换精致食材
        if ingredient == "butter": base["vegetable_oil"] = grams * 0.8
        elif ingredient == "cream": continue  # 去除奶油
        elif ingredient in premium_proteins: base[ingredient] = grams * 0.5
        else: base[ingredient] = grams
    base["cook_method"] = downgrade_method(refined_recipe["cook_method"])
    return base
```

模拟H值：使用跨家族平均α作为先验。

#### 步骤5：核心可视化

**精致化成本曲线图**（论文核心新图）：
- 多面板图，每个家族一个子图
- X轴：log(E/E_base)
- Y轴：H - H_base
- 每道菜一个点，OLS拟合线
- 对角线表示"等比例回报"，拟合线低于对角线→边际递减

**精致化效率条形图**：
```
refinement_efficiency_f = (H_max - H_min) / (E_max - E_min)
```
按家族排列，展示哪些食物类型的精致化最"值得"。

**味觉浪费图**：
```
hedonic_waste_f = 1 - [(H_refined - H_basic) / (H_max_possible - H_basic)]
                      / [(E_refined - E_basic) / (E_max_possible - E_basic)]
```

#### 步骤6：政策含义

**核心论点**：在每个菜品家族中，前50%的精致化（E增长）捕获了80%+的味觉提升。后50%的精致化是"环境浪费"。

**实操建议**：
- 餐厅可以提供"基础版"和"精致版"菜单选项
- 标注每道菜的"精致化溢价"（多花多少环境成本，多获多少口感）
- 消费者可以做知情选择

**输出**：
| 文件 | 内容 |
|------|------|
| `results/tables/dish_families.csv` | 334菜品→家族映射 |
| `results/tables/refinement_curves.csv` | 每家族α, CI, E_range, H_range |
| `results/tables/refinement_simulated_variants.csv` | 模拟基础版变体 |
| `results/figures/refinement_cost_curves.png` | **核心新图**：多面板精致化曲线 |
| `results/figures/refinement_global_fit.png` | 全局混合效应拟合 |
| `results/figures/hedonic_waste_by_family.png` | 家族级味觉浪费 |

---

### 脚本12：整合修订 (`code/12_integrated_revision.py`)

**依赖**：所有11a-11e输出

**内容**：

1. **影响矩阵**：五项修改如何改变核心结论

| 批评 | 原始结论 | 修订后 | 影响 |
|------|---------|--------|------|
| C1 H压缩 | H贡献0.8% | 需CV>20%才H贡献10%+ | 低（结论稳健） |
| C2 代理偏差 | 无控制 | 控制后DEI ρ>0.85 | 中 |
| C3 营养 | 无 | 牛肉菜升20-40位 | **高** |
| C4 类内 | 跨类比较 | 类内H区分力更强 | 中 |
| C5 精致化 | 无 | α≈0.5-1.5，边际递减 | **新贡献** |

2. **修订后Figure 1**：H vs E散点图，使用控制后H，带营养标注和类别编码

3. **更新数据集**：`combined_dish_DEI_revised.csv`，新增列：
   - `H_controlled`, `NDI`, `DEI_N`, `category_recipe`, `family`, `refinement_score`

4. **中文报告**：更新`results/研究一_结果报告.md`

---

## 三、执行计划

### 依赖图

```
config.py (扩展NUTRIENT_DATA, DISH_FAMILIES)
    │
    ├── 11a_h_decompression.py        ─┐
    ├── 11b_yelp_proxy_controls.py     ─┤ 可并行
    ├── 11c_nutritional_dimension.py   ─┤
    └── 11e_refinement_curve.py        ─┘
                                        │
         11d_within_category_analysis.py ← 依赖11c
                                        │
              12_integrated_revision.py  ← 依赖全部11x
```

### 工作量估算

| 脚本 | 代码量 | 数据工作 | 计算时间 |
|------|--------|---------|---------|
| 11a | ~200行 | 无 | <1 min |
| 11b | ~300行 | 需合并mentions+restaurants | ~3 min |
| 11c | ~400行 | **101食材USDA数据编码** | ~1 min |
| 11d | ~350行 | 依赖11c | ~1 min |
| 11e | ~500行 | 模拟数据生成 | ~2 min |
| 12 | ~300行 | 整合 | ~1 min |
| **总计** | **~2050行** | **USDA数据为主要瓶颈** | **~8 min** |

### 运行方式

```bash
PYTHON="/c/Users/C/AppData/Local/Programs/Python/Python313/python.exe"

# 先扩展config
# 然后并行运行11a, 11b, 11c, 11e
cd /c/project_EF && PYTHONIOENCODING=utf-8 $PYTHON code/11a_h_decompression.py &
cd /c/project_EF && PYTHONIOENCODING=utf-8 $PYTHON code/11b_yelp_proxy_controls.py &
cd /c/project_EF && PYTHONIOENCODING=utf-8 $PYTHON code/11c_nutritional_dimension.py &
cd /c/project_EF && PYTHONIOENCODING=utf-8 $PYTHON code/11e_refinement_curve.py &
wait

# 11d依赖11c
cd /c/project_EF && PYTHONIOENCODING=utf-8 $PYTHON code/11d_within_category_analysis.py

# 最后整合
cd /c/project_EF && PYTHONIOENCODING=utf-8 $PYTHON code/12_integrated_revision.py
```

---

## 四、关键风险与应对

| 风险 | 影响 | 应对 |
|------|------|------|
| USDA数据编码耗时 | 11c延迟 | 101食材中80+可直接查USDA，剩余用近似值 |
| expanded_dish_mentions.parquet可能不存在 | 11b无法处理176扩展菜 | 退回仅用158原始菜做控制分析 |
| 部分家族菜品不足3道 | 11e无法拟合 | 合并相近家族或用全局α |
| 控制后H可能出现负值 | 11b结果异常 | 加偏移量确保H > 0 |
| 3D Pareto前沿菜品过少 | 11c结论弱 | 放宽Pareto定义或用ε-dominance |

---

## 五、预期论文修改影响

### 对核心论点"环保饮食几乎不牺牲口感"的影响

**修订后的nuanced表述**：
> "在功能等价的菜品类别内（如同为蛋白质主菜），环保替代品的味觉损失有限（类内H差异 < 1分），但需考虑营养完整性。将营养密度纳入评估后，最优选择从纯植物配菜转向营养均衡的低环境成本主食。此外，精致化成本曲线分析表明，同一道菜从基础版到精致版的味觉收益呈边际递减——前50%的精致化捕获80%的味觉提升，后50%主要产生环境浪费。"

### 新增贡献
1. DEI-N三维指数（H × N / E）
2. 精致化成本曲线（全新概念）
3. 营养约束替代方案（实操性更强）
4. H压缩敏感性分析框架（方法论贡献）
